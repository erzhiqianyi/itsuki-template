---
// src/layouts/BaseLayout.astro
import { SITE_CONFIG } from '../data/site-config';
import { ClientRouter } from 'astro:transitions';
import { Icon } from 'astro-icon/components';

interface Props {
    title?: string;
    description?: string;
    image?: string;
    article?: boolean;
    lang?: 'ja' | 'en';
}

const {
    lang = 'ja',
    title = SITE_CONFIG.brand.logo,
    article = false,
} = Astro.props;

// --- 翻译辅助函数 ---
const t = (key: string) => {
    const labels = SITE_CONFIG.ui.labels as any;
    const headings = SITE_CONFIG.ui.headings as any;
    return labels[key]?.[lang] || headings[key]?.[lang] || key;
};

// --- SEO 逻辑 ---
const configDescription = SITE_CONFIG.brand.description[lang] || SITE_CONFIG.brand.description['ja'];
const description = Astro.props.description || configDescription;
const siteUrl = SITE_CONFIG.brand.siteUrl || 'https://erzhiqian.cc';
const canonicalURL = new URL(Astro.url.pathname, siteUrl);

// 确保 OG 图片使用绝对路径
const ogImage = new URL(Astro.props.image || '/og-default.jpg', siteUrl);
const siteTitle = title === SITE_CONFIG.brand.logo ? title : `${title} | ${SITE_CONFIG.brand.logo}`;

// --- 路径逻辑与更新时间 ---
const currentPath = Astro.url.pathname;
const lastUpdatedDate = new Date().toLocaleDateString(lang === 'ja' ? 'ja-JP' : 'en-US', {
    year: 'numeric', month: '2-digit', day: '2-digit'
});

// --- 路径转换逻辑 ---
const getLocalizedHref = (href: string) => {
    const cleanHref = href.startsWith('/') ? href : `/${href}`;
    if (cleanHref.includes('changelog')) return `/${lang}/changelog`;
    if (lang === 'en') {
        if (cleanHref === '/') return '/en';
        return cleanHref.startsWith('/en') ? cleanHref : `/en${cleanHref}`;
    }
    return cleanHref.replace(/\/$/, '') || '/';
};

const isPathActive = (href: string) => {
    const localizedHref = getLocalizedHref(href).replace(/\/$/, '');
    const normalizedPath = currentPath.replace(/\/$/, '');
    if (localizedHref === '' || localizedHref === '/en' || localizedHref === '/ja') {
        return normalizedPath === localizedHref;
    }
    return normalizedPath.startsWith(localizedHref);
};

const getSwitchLangHref = (targetLang: 'ja' | 'en') => {
    if (targetLang === lang) return currentPath;
    if (targetLang === 'en') {
        return `/en${currentPath}`.replace(/\/+$/, '').replace('/en/en', '/en') || '/en';
    } else {
        const path = currentPath.replace(/^\/en/, '') || '/';
        if (path.includes('changelog')) return '/ja/changelog';
        return path;
    }
};
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href={SITE_CONFIG.brand.favicon} />
    <meta name="generator" content={Astro.generator} />

    <title>{siteTitle}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <meta property="og:type" content={article ? "article" : "website"} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={siteTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={siteTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={ogImage} />

    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": article ? "BlogPosting" : "WebSite",
        "name": siteTitle,
        "url": canonicalURL.href,
        "image": ogImage.href
    })} />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <ClientRouter />
</head>
<body class="min-h-screen flex flex-col font-sans bg-[#1e1e2e] text-[#cdd6f4] antialiased">

<header id="main-header" class="fixed top-0 left-0 w-full z-[100] transition-all duration-500 border-b border-transparent py-1">
    <div class="max-w-7xl mx-auto px-4 lg:px-6 h-14 flex items-center justify-between gap-4">
        <a href={lang === 'en' ? '/en' : '/'} class="font-mono text-lg font-bold flex items-center gap-2 group flex-shrink-0">
            <div class="w-2 h-2 rounded-full bg-[#89b4fa] shadow-[0_0_15px_rgba(137,180,250,0.6)] group-hover:scale-125 transition-transform duration-500"></div>
            <span class="tracking-tight text-[#f5e0dc] group-hover:text-[#89b4fa] transition-colors">{SITE_CONFIG.brand.logo}</span>
        </a>

        <div class="hidden xl:flex items-center gap-1 flex-grow justify-end">
            <nav class="flex items-center gap-0.5 text-[12px] font-medium">
                {SITE_CONFIG.navigation.map((item) => {
                    const localizedHref = getLocalizedHref(item.href);
                    const isActive = isPathActive(item.href);
                    return (
                            <a href={localizedHref} class={`transition-all duration-300 relative group py-1.5 px-2.5 flex items-center gap-1.5 whitespace-nowrap rounded-full ${isActive ? 'text-[#89b4fa] bg-white/5' : `text-[#bac2de] ${item.color} hover:bg-white/5`}`}>
                                {item.icon && <Icon name={`lucide:${item.icon}`} class="w-3.5 h-3.5" />}
                                <span>{item.label[lang]}</span>
                                <span class={`absolute bottom-0 left-3 right-3 h-0.5 bg-[#89b4fa] transition-all duration-300 ${isActive ? 'opacity-100 shadow-[0_0_8px_rgba(137,180,250,0.4)]' : 'w-0 opacity-0 group-hover:w-[calc(100%-1.5rem)] group-hover:opacity-100'}`}></span>
                            </a>
                    )
                })}
            </nav>

            <div class="flex items-center bg-white/5 rounded-full p-1 border border-white/10 ml-2">
                <a href={getSwitchLangHref('ja')} class={`px-2.5 py-0.5 text-[10px] font-bold rounded-full transition-all ${lang === 'ja' ? 'bg-[#89b4fa] text-[#1e1e2e]' : 'text-[#a6adc8] hover:text-white'}`}>JA</a>
                <a href={getSwitchLangHref('en')} class={`px-2.5 py-0.5 text-[10px] font-bold rounded-full transition-all ${lang === 'en' ? 'bg-[#89b4fa] text-[#1e1e2e]' : 'text-[#a6adc8] hover:text-white'}`}>EN</a>
            </div>
        </div>

        <button id="menu-toggle" aria-label="Toggle Menu" class="xl:hidden p-2 text-[#a6adc8] hover:text-white transition-colors z-[110]">
            <Icon name="lucide:menu" class="w-6 h-6" />
        </button>
    </div>

    <div id="mobile-menu" class="hidden fixed inset-0 z-[105] bg-[#1e1e2e] flex-col items-center justify-center gap-8 px-6 transition-all duration-300">
        <nav class="flex flex-col items-center gap-6 text-xl font-bold">
            {SITE_CONFIG.navigation.map((item) => (
                    <a href={getLocalizedHref(item.href)} class="text-[#bac2de] hover:text-[#89b4fa]">
                        {item.label[lang]}
                    </a>
            ))}
        </nav>
        <div class="flex items-center bg-white/5 rounded-full p-1 border border-white/10">
            <a href={getSwitchLangHref('ja')} class={`px-6 py-2 text-sm font-bold rounded-full ${lang === 'ja' ? 'bg-[#89b4fa] text-[#1e1e2e]' : 'text-[#a6adc8]'}`}>JA</a>
            <a href={getSwitchLangHref('en')} class={`px-6 py-2 text-sm font-bold rounded-full ${lang === 'en' ? 'bg-[#89b4fa] text-[#1e1e2e]' : 'text-[#a6adc8]'}`}>EN</a>
        </div>
    </div>
</header>

<main class="flex-grow w-full max-w-6xl mx-auto px-6 pt-24 pb-20">
    <slot />
</main>

<footer class="mt-12 text-center text-xs font-mono pb-12 flex flex-col items-center gap-6">
    <div class="flex items-center gap-4 text-[10px] uppercase tracking-[0.2em] text-[#585b70]">
        <a href={SITE_CONFIG.brand.webring.prev} class="hover:text-[#89b4fa] transition-all">{t('prev')}</a>
        <span class="opacity-20">/</span>
        <a href={SITE_CONFIG.brand.webring.home} target="_blank" class="hover:text-white transition font-bold">{SITE_CONFIG.brand.webring.label}</a>
        <span class="opacity-20">/</span>
        <a href={SITE_CONFIG.brand.webring.next} class="hover:text-[#89b4fa] transition-all">{t('next')}</a>
    </div>

    <div class="text-[#6c7086] opacity-80 flex flex-col sm:flex-row items-center gap-2">
        <div>{SITE_CONFIG.brand.footer} • <span class="text-[#f5e0dc]">{t('builtWith')}</span></div>
        <span class="hidden sm:inline opacity-30">|</span>
        <a href={getLocalizedHref('/changelog')} class="group flex items-center gap-1.5 hover:text-[#89b4fa] transition-colors">
            <Icon name="lucide:history" class="w-3 h-3 opacity-50 group-hover:opacity-100" />
            <span>{t('updated')}: <span class="text-[#f5e0dc] group-hover:text-[#89b4fa] underline underline-offset-4 decoration-[#585b70]">{lastUpdatedDate}</span></span>
        </a>
    </div>
</footer>

<script>
    function setupMenu() {
        const toggle = document.getElementById('menu-toggle');
        const menu = document.getElementById('mobile-menu');

        if (toggle && menu) {
            // 使用 addEventListener 替代直接赋值，增加稳定性
            const handleToggle = () => {
                const isHidden = menu.classList.contains('hidden');
                if (isHidden) {
                    menu.classList.remove('hidden');
                    menu.classList.add('flex');
                    document.body.style.overflow = 'hidden'; // 禁止滚动
                } else {
                    menu.classList.add('hidden');
                    menu.classList.remove('flex');
                    document.body.style.overflow = '';
                }
            };

            toggle.addEventListener('click', handleToggle);

            // 点击链接后自动关闭
            menu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    menu.classList.add('hidden');
                    menu.classList.remove('flex');
                    document.body.style.overflow = '';
                });
            });
        }
    }

    function handleScroll() {
        const header = document.getElementById('main-header');
        if (header) {
            if (window.scrollY > 20) {
                header.classList.add('bg-[#1e1e2e]/80', 'backdrop-blur-xl', 'border-white/10', 'shadow-lg', 'py-2');
                header.classList.remove('border-transparent', 'py-1');
            } else {
                header.classList.remove('bg-[#1e1e2e]/80', 'backdrop-blur-xl', 'border-white/10', 'shadow-lg', 'py-2');
                header.classList.add('border-transparent', 'py-1');
            }
        }
    }

    const init = () => {
        setupMenu();
        handleScroll();
        window.addEventListener('scroll', handleScroll);
    };

    // 适配 Astro View Transitions
    init();
    document.addEventListener('astro:after-swap', init);
</script>
</body>
</html>