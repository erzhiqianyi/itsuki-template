---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { SITE_CONFIG } from '../../../../data/site-config';

export async function getStaticPaths({ paginate }) {
    const allPhotos = await getCollection('photos') || [];
    const getTags = (key) => [...new Set(allPhotos.map(p => p.data[key]).filter(Boolean))];
    const allUniqueTags = [...new Set([...getTags('location_tag'), ...getTags('year_tag'), ...getTags('collection_tag')])];

    return allUniqueTags.flatMap(tag => {
        const filtered = allPhotos.filter(p =>
            p.data.location_tag === tag || p.data.year_tag === tag || p.data.collection_tag === tag
        ).sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));

        return paginate(filtered, {
            params: { tag },
            pageSize: 3
        });
    });
}

const { page } = Astro.props;
const { tag } = Astro.params;
const lang = Astro.url.pathname.startsWith('/en') ? 'en' : 'ja';

// --- 同样需要提取标签导航数据 ---
const allForNav = await getCollection('photos');
const getNavTags = (key) => ['All', ...new Set(allForNav.map(p => p.data[key]).filter(Boolean))].sort();
const navOptions = {
    collections: getNavTags('collection_tag'),
    locations: getNavTags('location_tag'),
    years: getNavTags('year_tag'),
};

const clientPhotos = page.data.map(p => ({
    image: p.data.image,
    title: p.data.title[lang] || p.data.title,
    location: p.data.location[lang] || p.data.location,
    gear: p.data.gear
}));

const range = 3;
let startPage = Math.max(1, page.currentPage - Math.floor(range / 2));
let endPage = Math.min(page.lastPage, startPage + range - 1);
if (endPage - startPage + 1 < range) startPage = Math.max(1, endPage - range + 1);
const pageButtons = Array.from({ length: endPage - startPage + 1 }, (_, i) => startPage + i);
---

<BaseLayout title={`Photos - ${tag}`} lang={lang}>
    <div class="max-w-6xl mx-auto px-6 py-10 space-y-12">

        <header class="pt-8">
            <h1 class="text-5xl font-black text-white italic border-b-4 border-[var(--peach)]/10 inline-block pb-1">
                {tag}
            </h1>
        </header>

        <nav class="space-y-2 bg-white/[0.01] p-6 rounded-[2.5rem] border border-white/5 backdrop-blur-xl">
            {Object.entries({ collection: navOptions.collections, location: navOptions.locations, year: navOptions.years }).map(([type, tags]) => (
                    <div class="flex flex-col md:flex-row md:items-center gap-4 py-2 border-b last:border-0 border-white/5">
                        <div class="w-24 shrink-0 text-[9px] font-black text-white/20 uppercase tracking-widest font-mono">
                            {type.toUpperCase()}
                        </div>
                        <div class="flex flex-wrap gap-1.5">
                            {tags.map(val => {
                                // 关键：判断当前 tag 是否匹配
              const isActive = val === tag;
                                const link = val === 'All' ? '/photos' : `/photos/tags/${val}/1`;
                                return (
                                        <a href={link} class={`px-3 py-1 rounded-lg border text-[10px] font-mono transition-all ${isActive ? 'bg-[var(--peach)] text-[#1e1e2e] border-[var(--peach)] font-black' : 'bg-white/5 text-[var(--subtext)] border-white/5 hover:text-white'}`}>
                                            {val}
                                        </a>
                                )
                            })}
                        </div>
                    </div>
            ))}
        </nav>

        <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {page.data.map((p, index) => (
                    <article class="group cursor-zoom-in relative rounded-[2.5rem] overflow-hidden border border-white/5 bg-[#313244]/20" onclick={`window.openLightbox(${index})`}>
                        <img src={p.data.image} alt="" class="w-full aspect-square object-cover group-hover:scale-110 transition-transform duration-700" />
                    </article>
            ))}
        </main>

        <nav class="flex justify-center items-center gap-2 pb-20">
            <a href={page.url.prev || "#"} class={`p-3 rounded-xl bg-white/5 ${!page.url.prev && 'opacity-10'}`}>←</a>
            {pageButtons.map(num => (
                    <a href={`/photos/tags/${tag}/${num}`} class={`w-10 h-10 flex items-center justify-center rounded-xl font-mono text-xs ${num === page.currentPage ? 'bg-[var(--peach)] text-black font-black' : 'bg-white/5 text-white/40'}`}>
                        {num}
                    </a>
            ))}
            <a href={page.url.next || "#"} class={`p-3 rounded-xl bg-white/5 ${!page.url.next && 'opacity-10'}`}>→</a>
        </nav>
    </div>

    <div id="lightbox" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center bg-black/95 backdrop-blur-2xl p-4" onclick="if(event.target===this)window.closeLightbox()">
        <img id="lb-img" src="" class="max-w-full max-h-[75vh] rounded-3xl object-contain shadow-2xl" />
        <div class="mt-6 text-center text-white">
            <h3 id="lb-title" class="text-xl font-black italic"></h3>
            <p id="lb-meta" class="font-mono text-[10px] text-[var(--peach)] mt-1 uppercase"></p>
        </div>
    </div>

    <script is:inline define:vars={{ clientPhotos }}>
        window.openLightbox = (index) => {
            const photo = clientPhotos[index];
            document.getElementById('lb-img').src = photo.image;
            document.getElementById('lb-title').innerText = photo.title;
            document.getElementById('lb-meta').innerText = `${photo.location} | ${photo.gear}`;
            document.getElementById('lightbox').classList.replace('hidden', 'flex');
            document.body.style.overflow = 'hidden';
        };
        window.closeLightbox = () => {
            document.getElementById('lightbox').classList.replace('flex', 'hidden');
            document.body.style.overflow = '';
        };
    </script>
</BaseLayout>