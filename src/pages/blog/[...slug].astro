---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { SITE_CONFIG } from '../../data/site-config';

/**
 * 博客详情页路由
 * 采用 [...slug] 模式支持嵌套路径
 * 修复了导入语法问题，并确保路由生成逻辑与列表页一致
 */

export async function getStaticPaths() {
    const blogEntries = await getCollection('blog');
    if (!blogEntries) return [];

    return blogEntries.map((entry) => ({
        // 移除 id 中的 .md 或 .mdx 后缀，生成干净的 URL
        params: {
            slug: entry.id.replace(/\.(md|mdx)$/, '')
        },
        props: { entry },
    }));
}

const { entry } = Astro.props;

// 健壮性检查
if (!entry) {
    return Astro.redirect('/404');
}

// 渲染 Markdown 内容
const { Content, headings } = await render(entry);
const {
    title,
    date,
    category,
    tags,
    coverImage,
    lang = 'ja',
    series
} = entry.data;

// 提取目录 (H2 和 H3)
const toc = (headings || []).filter((h) => h.depth === 2 || h.depth === 3);

// UI 文本定义
const postUI = {
    back: { ja: "一覧に戻る", en: "Back to List" },
    toc: { ja: "目次内容", en: "CONTENTS" },
    prev: { ja: "前の記事", en: "PREVIOUS" },
    next: { ja: "エクスプローラー", en: "EXPLORER" },
    returnIdx: { ja: "記事一覧へ戻る", en: "Return to Index" }
};
---

    <BaseLayout title={`${title} - ${SITE_CONFIG.brand.logo}`} lang={lang as 'ja' | 'en'}>
<div class="grid grid-cols-1 lg:grid-cols-12 gap-12 text-left">

<!-- 侧边栏 (仅在桌面端显示) -->
<aside class="hidden lg:block lg:col-span-3">
<div class="sticky top-32 space-y-10">
<!-- 返回文章列表 -->
<a href="/blog" class="flex items-center gap-2 text-sm text-[var(--subtext)] hover:text-[var(--accent)] transition group">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:-translate-x-1 transition-transform"><path d="m15 18-6-6 6-6"/></svg>
    <span>{postUI.back[lang]}</span>
    </a>

<!-- 系列文章导航 -->
{series && (
    <div class="space-y-4">
    <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-[var(--pink)]">
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    <span>{series.title[lang]}</span>
    </div>
    <div class="flex flex-col text-[11px] bg-white/[0.02] rounded-2xl overflow-hidden border border-white/5 font-bold">
{series.items.map((item, idx) => (
        <a
            href={item.href}
    class={`p-3 border-b border-white/5 last:border-0 hover:bg-white/5 flex gap-3 ${item.active ? 'bg-[var(--accent)]/5 text-[var(--accent)] border-r-2 border-r-[var(--accent)]' : 'text-[var(--subtext)]'}`}
>
<span class="opacity-30">{String(idx + 1).padStart(2, '0')}</span>
<span class="flex-1 truncate text-left">{item.title[lang]}</span>
    {item.active && (
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="mt-0.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    )}
    </a>
))}
    </div>
    </div>
)}

<!-- 文章目录 (TOC) -->
{toc.length > 0 && (
    <div class="space-y-4">
    <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-[var(--accent)]">
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="21" x2="3" y1="6"/><line x1="15" x2="3" y1="12"/><line x1="17" x2="3" y1="18"/></svg>
    <span>{postUI.toc[lang]}</span>
    </div>
    <nav class="flex flex-col gap-4 text-[11px] font-bold text-[var(--subtext)] border-l border-white/5">
    {toc.map((h) => (
            <a
                href={`#${h.slug}`}
    class={`pl-6 py-1 border-l-2 border-transparent hover:border-[var(--accent)] hover:text-white transition truncate ${h.depth === 3 ? 'ml-4 opacity-70' : ''}`}
>
    {h.text}
    </a>
))}
    </nav>
    </div>
)}
</div>
</aside>

<!-- 文章正文区域 -->
<article class="lg:col-span-9 xl:col-span-8 mx-auto w-full max-w-3xl">
<!-- 头部元数据 -->
<header class="mb-16 space-y-8">
<div class="flex items-center gap-4 text-[10px] font-black font-mono tracking-widest uppercase text-[var(--accent)]">
<span class="px-3 py-1 bg-[var(--accent)]/10 rounded-md border border-[var(--accent)]/20">{category}</span>
    <span class="text-gray-500">{date}</span>
    </div>
    <h1 class="text-5xl md:text-6xl font-black text-white leading-[1.1] tracking-tight text-left">
    {title}
    </h1>
    <div class="flex flex-wrap gap-3">
    {tags.map((tag) => (
            <span class="px-3 py-1 bg-white/5 text-[var(--subtext)] rounded-lg text-[9px] border border-white/10 font-mono font-bold">#{tag}</span>
        ))}
    </div>
    <!-- 封面图 -->
    <div class="rounded-[2.5rem] overflow-hidden border border-white/5 aspect-video bg-white/5 shadow-2xl relative">
<img src={coverImage} class="absolute inset-0 w-full h-full object-cover" alt={title} />
<div class="absolute inset-0 bg-gradient-to-t from-bg via-transparent to-transparent opacity-50"></div>
    </div>
    </header>

    <!-- 正文内容渲染 -->
    <div class="article-content prose prose-invert max-w-none mb-20">
    <Content />
    </div>

    <!-- 底部导航 -->
    <nav class="grid grid-cols-1 md:grid-cols-2 gap-10 border-t border-white/10 pt-20 mt-32">
<div class="p-12 bg-white/[0.02] border border-white/5 rounded-[3.5rem] opacity-20 flex flex-col justify-center">
<span class="text-[11px] font-mono uppercase tracking-[0.3em] text-[var(--subtext)] text-left">{postUI.prev[lang]}</span>
    <p class="text-sm font-bold text-white mt-4 text-left">---</p>
    </div>
    <a href="/blog" class="p-12 bg-white/[0.02] hover:bg-white/5 border border-white/10 rounded-[3.5rem] transition-all text-right flex flex-col items-end group shadow-lg">
<span class="text-[11px] font-mono text-[var(--accent)] uppercase tracking-[0.3em] group-hover:translate-x-3 transition-transform">{postUI.next[lang]}</span>
    <span class="text-2xl font-black text-white mt-4 leading-tight">{postUI.returnIdx[lang]}</span>
    </a>
    </nav>
    </article>
    </div>
    </BaseLayout>

    <style is:global>
/* 还原设计稿的精美排版样式 */
.article-content h2 {
    font-size: 2.25rem;
    font-weight: 900;
    font-style: italic;
    color: #ffffff;
    line-height: 1.1;
    margin: 5rem 0 1.5rem;
    position: relative;
    padding-left: 1.5rem;
    border-left: 6px solid var(--accent);
}

.article-content h2 + * {
    border-top: 1px solid rgba(137, 180, 250, 0.2);
padding-top: 2rem;
}

.article-content h3 {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--accent);
    margin: 3.5rem 0 1.5rem;
}

.article-content p {
    font-size: 1.1rem;
    line-height: 2.1;
    color: var(--subtext);
    margin-bottom: 2.5rem;
    letter-spacing: 0.015em;
    text-align: left;
}

.article-content blockquote {
    background: rgba(137, 180, 250, 0.04);
    border-left: 4px solid var(--accent);
    padding: 2.5rem;
    border-radius: 1.5rem;
    margin: 4rem 0;
    color: var(--text);
    line-height: 1.8;
    text-align: left;
}

.article-content ul, .article-content ol {
    margin-bottom: 2.5rem;
    text-align: left;
}

.article-content li {
    position: relative;
    padding-left: 2rem;
    margin-bottom: 1.2rem;
    color: var(--subtext);
    line-height: 1.8;
}

.article-content li::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0.8em;
    width: 8px;
    height: 2px;
    background: var(--accent);
}

.article-content strong {
    color: #ffffff;
    font-weight: 900;
}

.article-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 4rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 1.5rem;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.article-content th {
    padding: 1.25rem;
    font-weight: 900;
    color: var(--accent);
    border-bottom: 2px solid rgba(137, 180, 250, 0.1);
    background: rgba(137, 180, 250, 0.03);
    text-align: left;
}

.article-content td {
    padding: 1.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    color: var(--subtext);
    text-align: left;
}

/* 锚点平滑滚动与头部偏移 */
html { scroll-padding-top: 100px; }
</style>