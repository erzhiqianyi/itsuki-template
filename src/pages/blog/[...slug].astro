---
// src/pages/blog/[...slug].astro
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { SITE_CONFIG } from '../../data/site-config';
import { Icon } from 'astro-icon/components';

export async function getStaticPaths() {
    const blogEntries = await getCollection('blog');
    if (!blogEntries) return [];

    const sortedEntries = blogEntries.sort((a, b) =>
        new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
    );

    return sortedEntries.map((entry) => {
        const currentLang = entry.data.lang || 'ja';
        const sameLangPosts = sortedEntries.filter(
            (post) => (post.data.lang || 'ja') === currentLang
        );
        const currentIndex = sameLangPosts.findIndex((p) => p.id === entry.id);

        return {
            params: {
                slug: entry.id.replace(/\.(md|mdx)$/, '')
            },
            props: {
                entry,
                nextPost: currentIndex > 0 ? sameLangPosts[currentIndex - 1] : null,
                prevPost: currentIndex < sameLangPosts.length - 1 ? sameLangPosts[currentIndex + 1] : null,
            },
        };
    });
}

const { entry, prevPost, nextPost } = Astro.props;

if (!entry) return Astro.redirect('/404');

const { Content, headings } = await render(entry);

// --- 统计逻辑 ---
const rawContent = entry.body || '';
const wordCount = rawContent.match(/[\u4e00-\u9fa5]|[\u3040-\u309F]|[\u30A0-\u30FF]|\w+/g)?.length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 400));
const formattedWordCount = wordCount > 1000 ? (wordCount / 1000).toFixed(1) + 'k' : wordCount;

const {
    title,
    date,
    category,
    tags,
    coverImage,
    summary,
    lang = 'ja',
    series
} = entry.data;

const postDescription = summary;
const toc = (headings || []).filter((h) => h.depth === 2 || h.depth === 3);

const postUI = {
    back: { ja: "一覧に戻る", en: "Back to List" },
    toc: { ja: "目次内容", en: "CONTENTS" },
    prev: { ja: "前の記事", en: "PREVIOUS" },
    next: { ja: "次の記事", en: "NEXT" },
    returnIdx: { ja: "記事一覧へ戻る", en: "Return to Index" },
    stats: {
        words: { ja: "文字", en: "words" },
        mins: { ja: "分", en: "min" }
    }
};

const getPostUrl = (id: string) => `/blog/${id.replace(/\.(md|mdx)$/, '')}`;
---

<BaseLayout
        title={title}
        description={postDescription}
        image={coverImage}
        article={true}
        lang={lang as 'ja' | 'en'}
>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 text-left">
        <!-- 左侧边栏 -->
        <aside class="hidden lg:block lg:col-span-3">
            <div class="sticky top-32 space-y-10">
                <a href="/blog" class="flex items-center gap-2 text-sm text-[var(--subtext)] hover:text-[var(--accent)] transition group font-bold">
                    <Icon name="lucide:chevron-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform" />
                    <span>{postUI.back[lang]}</span>
                </a>

                {series && (
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-[var(--pink)]">
                                <Icon name="lucide:book-open" class="w-3.5 h-3.5" />
                                <span>{series.title[lang]}</span>
                            </div>
                            <div class="flex flex-col text-[11px] bg-white/[0.02] rounded-2xl overflow-hidden border border-white/5 font-bold">
                                {series.items.map((item, idx) => (
                                        <a href={item.href} class={`p-3 border-b border-white/5 last:border-0 hover:bg-white/5 flex gap-3 ${item.active ? 'bg-[var(--accent)]/10 text-[var(--accent)] border-r-2 border-r-[var(--accent)]' : 'text-[var(--subtext)]'}`}>
                                            <span class="opacity-30">{String(idx + 1).padStart(2, '0')}</span>
                                            <span class="flex-1 truncate text-left">{item.title[lang]}</span>
                                            {item.active && <div class="w-1 h-1 rounded-full bg-[var(--accent)] mt-1.5 animate-pulse"></div>}
                                        </a>
                                ))}
                            </div>
                        </div>
                )}

                {toc.length > 0 && (
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-[var(--accent)]">
                                <Icon name="lucide:list" class="w-3.5 h-3.5" />
                                <span>{postUI.toc[lang]}</span>
                            </div>
                            <nav class="flex flex-col gap-1 text-[11px] font-bold text-[var(--subtext)] border-l border-white/5">
                                {toc.map((h) => (
                                        <a href={`#${h.slug}`} class={`pl-6 py-2 border-l-2 border-transparent hover:border-[var(--accent)] hover:text-white transition-all truncate ${h.depth === 3 ? 'ml-4 opacity-70 text-[10px]' : ''}`}>
                                            {h.text}
                                        </a>
                                ))}
                            </nav>
                        </div>
                )}
            </div>
        </aside>

        <!-- 内容主体 -->
        <article class="lg:col-span-9 xl:col-span-8 mx-auto w-full max-w-3xl">
            <header class="mb-16 space-y-8">
                <!-- 元数据 -->
                <div class="flex flex-wrap items-center gap-y-4 gap-x-6 text-[10px] font-black font-mono tracking-widest uppercase">
                    <span class="px-3 py-1 bg-[var(--accent)]/10 text-[var(--accent)] rounded-md border border-[var(--accent)]/20">{category}</span>

                    <div class="flex items-center gap-4 text-gray-500">
                        <span class="flex items-center gap-1.5">
                            <Icon name="lucide:calendar" class="w-3 h-3 text-[var(--peach)]" />
                            {date}
                        </span>

                        <div class="flex items-center gap-3 border-l border-white/10 pl-4">
                             <span class="flex items-center gap-1.5">
                                <Icon name="lucide:file-text" class="w-3 h-3 text-[var(--accent)]" />
                                 {formattedWordCount} <span class="opacity-40">{postUI.stats.words[lang]}</span>
                            </span>
                            <span class="flex items-center gap-1.5">
                                <Icon name="lucide:clock" class="w-3 h-3 text-[var(--green)]" />
                                {readingTime} <span class="opacity-40">{postUI.stats.mins[lang]}</span>
                            </span>
                        </div>
                    </div>
                </div>

                <h1 class="text-5xl md:text-6xl font-black text-white leading-[1.1] tracking-tight text-left italic">
                    {title}
                </h1>

                <!-- 新增：文章摘要显示区域 -->
                {summary && (
                        <div class="relative py-8 px-10 bg-white/[0.02] border-l-4 border-[var(--accent)] rounded-r-3xl overflow-hidden group/summary shadow-lg">
                            <p class="text-lg text-[var(--subtext)] font-medium leading-relaxed italic opacity-90 relative z-10">
                                {summary}
                            </p>
                            <!-- 装饰用大括号 -->
                            <div class="absolute -top-2 -left-2 text-[var(--accent)] opacity-[0.05] group-hover/summary:opacity-10 transition-opacity">
                                <Icon name="lucide:quote" class="w-20 h-20 rotate-180" />
                            </div>
                        </div>
                )}

                <div class="flex flex-wrap gap-3">
                    {tags.map((tag) => (
                            <span class="px-3 py-1 bg-white/5 text-[var(--subtext)] rounded-lg text-[9px] border border-white/10 font-mono font-bold hover:border-[var(--accent)]/40 transition-colors">#{tag}</span>
                    ))}
                </div>

                {coverImage && (
                        <div class="rounded-[2.5rem] overflow-hidden border border-white/5 aspect-video bg-white/5 shadow-2xl relative group">
                            <img src={coverImage} class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt={title} />
                            <div class="absolute inset-0 bg-gradient-to-t from-bg via-transparent to-transparent opacity-50"></div>
                        </div>
                )}
            </header>

            <div class="article-content prose prose-invert max-w-none mb-20">
                <Content />
            </div>

            <!-- 底部导航 -->
            <nav class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-white/10 pt-20 mt-32">
                {prevPost ? (
                        <a href={getPostUrl(prevPost.id)} class="p-8 bg-white/[0.02] hover:bg-white/5 border border-white/5 rounded-[2.5rem] transition-all group">
                            <span class="text-[10px] font-mono uppercase tracking-widest text-[var(--subtext)]">{postUI.prev[lang]}</span>
                            <p class="text-lg font-bold text-white mt-2 line-clamp-2 group-hover:text-[var(--accent)] transition-colors">{prevPost.data.title}</p>
                        </a>
                ) : (
                        <div class="p-8 bg-white/[0.01] border border-dashed border-white/5 rounded-[2.5rem] opacity-30 flex flex-col justify-center">
                            <span class="text-[10px] font-mono uppercase tracking-widest text-[var(--subtext)]">End of Road</span>
                            <p class="text-sm font-bold text-white mt-2">これが最初の記事です</p>
                        </div>
                )}

                {nextPost ? (
                        <a href={getPostUrl(nextPost.id)} class="p-8 bg-[var(--accent)]/5 hover:bg-[var(--accent)]/10 border border-[var(--accent)]/10 rounded-[2.5rem] transition-all text-right group">
                            <span class="text-[10px] font-mono text-[var(--accent)] uppercase tracking-widest group-hover:translate-x-1 transition-transform inline-block">{postUI.next[lang]}</span>
                            <p class="text-lg font-bold text-white mt-2 line-clamp-2">{nextPost.data.title}</p>
                        </a>
                ) : (
                        <a href="/blog" class="p-8 bg-white/[0.02] hover:bg-white/5 border border-white/10 rounded-[2.5rem] transition-all text-right group flex flex-col items-end shadow-lg">
                            <span class="text-[10px] font-mono text-[var(--accent)] uppercase tracking-widest group-hover:translate-x-1 transition-transform inline-block">{postUI.next[lang]}</span>
                            <span class="text-lg font-bold text-white mt-2 leading-tight">{postUI.returnIdx[lang]}</span>
                        </a>
                )}
            </nav>
        </article>
    </div>
</BaseLayout>

<style is:global>
    /* 排版设计还原 */
    .article-content h2 {
        font-size: 2.25rem; font-weight: 900; font-style: italic; color: #ffffff;
        line-height: 1.1; margin: 5rem 0 1.5rem; position: relative; padding-left: 1.5rem; border-left: 6px solid var(--accent);
    }
    .article-content h2 + * { border-top: 1px solid rgba(137, 180, 250, 0.2); padding-top: 2rem; }
    .article-content h3 { font-size: 1.5rem; font-weight: 800; color: var(--accent); margin: 3.5rem 0 1.5rem; }
    .article-content p { font-size: 1.1rem; line-height: 2.1; color: var(--subtext); margin-bottom: 2.5rem; letter-spacing: 0.015em; text-align: left; }
    .article-content blockquote {
        background: rgba(137, 180, 250, 0.04); border-left: 4px solid var(--accent);
        padding: 2.5rem; border-radius: 1.5rem; margin: 4rem 0; color: var(--text); line-height: 1.8; text-align: left;
    }
    .article-content ul, .article-content ol { margin-bottom: 2.5rem; text-align: left; }
    .article-content li { position: relative; padding-left: 2rem; margin-bottom: 1.2rem; color: var(--subtext); line-height: 1.8; }
    .article-content li::before { content: ""; position: absolute; left: 0; top: 0.8em; width: 8px; height: 2px; background: var(--accent); }
    .article-content strong { color: #ffffff; font-weight: 900; }
    .article-content table { width: 100%; border-collapse: collapse; margin-bottom: 4rem; background: rgba(255, 255, 255, 0.02); border-radius: 1.5rem; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.05); }
    .article-content th { padding: 1.25rem; font-weight: 900; color: var(--accent); border-bottom: 2px solid rgba(137, 180, 250, 0.1); background: rgba(137, 180, 250, 0.03); text-align: left; }
    .article-content td { padding: 1.25rem; border-bottom: 1px solid rgba(255, 255, 255, 0.03); color: var(--subtext); text-align: left; }
    :target { scroll-margin-top: 120px; }
</style>