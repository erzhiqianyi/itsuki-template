---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_CONFIG, t } from '../data/site-config';

// 1. 获取当前语言环境下的真实数据
const lang = 'ja';
const allBlogEntries = await getCollection('blog', ({ data }) => {
    return data.lang === lang;
});

// 2. 数据排序：默认按日期降序排列
const sortedPosts = allBlogEntries.sort(
    (a, b) => Date.parse(b.data.date) - Date.parse(a.data.date)
);

// 3. 动态提取分类及其统计数量
const categoryCounts = sortedPosts.reduce((acc, post) => {
    const cat = post.data.category;
    acc[cat] = (acc[cat] || 0) + 1;
    return acc;
}, {} as Record<string, number>);

const dynamicCategories = Object.entries(categoryCounts).map(([label, count]) => ({
    id: label.toLowerCase(),
    label,
    count
}));

// 4. 获取推荐文章 (由 Markdown 中的 featured: true 属性控制)
const featuredPosts = sortedPosts.filter(post => post.data.featured).slice(0, 3);

/**
 * 修复说明：
 * 5. 准备数据时，使用 .replace(/\.(md|mdx)$/, '') 移除 ID 里的后缀名。
 * 这样跳转时生成的 URL 就是干净的 /blog/post 而不是 /blog/post.md。
 */
const clientPosts = sortedPosts.map(post => ({
    id: post.id.replace(/\.(md|mdx)$/, ''),
    title: post.data.title,
    summary: post.data.summary || "",
    date: post.data.date,
    tag: post.data.category,
    cover: post.data.coverImage,
    category: post.data.category.toLowerCase()
}));

// UI 文本字典
const blogUI = {
    search: { ja: "検索", en: "Search" },
    categories: { ja: "カテゴリー", en: "Categories" },
    featured: { ja: "おすすめ", en: "Featured" },
    allPosts: { ja: "すべての記事", en: "All Posts" },
    noResults: { ja: "記事が見つかりませんでした", en: "No results found" },
    readMore: { ja: "詳しく見る", en: "Read More" }
};
---

    <BaseLayout title={`Blog - ${SITE_CONFIG.brand.logo}`} lang={lang}>
<div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

<!-- 侧边栏 (控制区) -->
<aside class="space-y-6 order-2 lg:order-1 text-left">
<!-- 搜索组件 -->
<div class="bento-card rounded-3xl p-6">
<h3 class="text-xs font-bold uppercase tracking-widest text-[var(--accent)] mb-4 flex items-center gap-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
{blogUI.search[lang]}
</h3>
<input
type="text"
id="search-input"
class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm text-white focus:outline-none focus:border-[var(--accent)]/50 transition-all"
placeholder="Search posts..."
    />
    </div>

    <!-- 动态生成的分类列表 -->
    <div class="bento-card rounded-3xl p-6">
<h3 class="text-xs font-bold uppercase tracking-widest text-[var(--green)] mb-4 flex items-center gap-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/></svg>
{blogUI.categories[lang]}
</h3>
<div class="space-y-1">
    {dynamicCategories.map(cat => (
            <button
                class="category-btn w-full flex justify-between items-center px-4 py-2 rounded-xl transition-all hover:bg-white/5 text-[var(--subtext)] group text-left"
        data-category={cat.id}
        >
        <span class="text-sm font-semibold group-hover:text-white transition-colors">{cat.label}</span>
            <span class="text-[10px] font-mono opacity-40 group-hover:opacity-100">{cat.count}</span>
        </button>
))}
</div>
</div>

<!-- 推荐文章区域 (由 Markdown Frontmatter 控制) -->
{featuredPosts.length > 0 && (
    <div class="bento-card rounded-3xl p-6">
    <h3 class="text-xs font-bold uppercase tracking-widest text-[var(--peach)] mb-4 flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3z"/></svg>
    {blogUI.featured[lang]}
    </h3>
    <div class="space-y-4">
    {featuredPosts.map(post => (
            <a href={`/blog/${post.id.replace(/\.(md|mdx)$/, '')}`} class="flex gap-4 group">
<div class="w-14 h-14 rounded-2xl bg-[#181825] overflow-hidden shrink-0 border border-white/5">
<img src={post.data.coverImage} class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition duration-700" alt="">
    </div>
    <div class="min-w-0 flex flex-col justify-center">
<h4 class="text-[12px] font-bold text-white group-hover:text-[var(--accent)] transition truncate leading-tight mb-1">{post.data.title}</h4>
    <span class="text-[9px] font-mono text-gray-500">{post.data.date}</span>
    </div>
    </a>
))}
    </div>
    </div>
)}
</aside>

<!-- 文章列表主体 -->
<div class="lg:col-span-3 space-y-6 order-1 lg:order-2">
<div class="flex justify-between items-center px-2">
<h2 class="text-xl font-bold text-white flex items-center gap-2">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--accent)]"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
{blogUI.allPosts[lang]}
</h2>
<!-- 当前过滤标签状态 -->
<div id="active-filter-tag" class="hidden text-[10px] font-mono bg-[var(--accent)]/10 text-[var(--accent)] px-2 py-1 rounded border border-[var(--accent)]/20 uppercase font-bold tracking-widest"></div>
    </div>

    <!-- 动态渲染容器 -->
    <div id="posts-container" class="space-y-6 min-h-[500px]">
    <!-- 初始内容由脚本填充 -->
    </div>

    <!-- 分页控制 -->
    <div id="pagination-container" class="flex justify-center items-center gap-2 pt-12"></div>
    </div>
    </div>

    <!-- 客户端交互逻辑 -->
    <script is:inline define:vars={{ clientPosts, lang, blogUI }}>
// 全局状态管理
window.blogState = {
    currentPage: 1,
    currentCategory: null,
    searchQuery: "",
    postsPerPage: 6
};

function renderPosts() {
    const container = document.getElementById('posts-container');
    if (!container) return;

    const { currentPage, currentCategory, searchQuery, postsPerPage } = window.blogState;

    // 1. 数据过滤
    const filtered = clientPosts.filter(post => {
        const matchesSearch = post.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            post.summary.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesCategory = !currentCategory || post.category === currentCategory;
        return matchesSearch && matchesCategory;
    });

    // 2. 分页处理
    const totalPages = Math.ceil(filtered.length / postsPerPage);
    const start = (currentPage - 1) * postsPerPage;
    const paginated = filtered.slice(start, start + postsPerPage);

    // 3. 渲染 HTML
    if (paginated.length === 0) {
        container.innerHTML = `<div class="py-20 text-center opacity-40 font-mono text-sm">${blogUI.noResults[lang]}</div>`;
        renderPagination(0);
        return;
    }

    container.innerHTML = paginated.map(post => `
        <a href="/blog/${post.id}" class="bento-card rounded-[2.5rem] overflow-hidden flex flex-col sm:flex-row group w-full items-stretch min-h-[280px]">
          <div class="sm:w-80 w-full h-64 sm:h-auto shrink-0 relative border-r border-white/5 overflow-hidden bg-[#181825]">
            <img 
              src="${post.cover}" 
              class="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:scale-105 group-hover:opacity-100 transition duration-[1.5s]" 
              alt="${post.title}"
            >
          </div>
          <div class="p-8 md:p-10 flex flex-col justify-between flex-1 text-left bg-gradient-to-br from-white/[0.02] to-transparent">
            <div>
              <div class="flex items-center gap-4 mb-4 text-[10px] font-mono font-bold uppercase tracking-wider">
                <span class="text-[var(--accent)] bg-[var(--accent)]/10 px-2 py-0.5 rounded border border-[var(--accent)]/20">${post.tag}</span>
                <span class="text-gray-500">${post.date}</span>
              </div>
              <h3 class="text-2xl font-bold text-white mb-4 group-hover:text-[var(--accent)] transition duration-300 leading-tight">
                ${post.title}
              </h3>
              <p class="text-[14px] text-[var(--subtext)] leading-relaxed line-clamp-3">
                ${post.summary}
              </p>
            </div>
            <div class="mt-8 pt-6 border-t border-white/5 flex justify-end items-center">
              <span class="text-[var(--accent)] font-black group-hover:translate-x-2 transition-transform duration-300 flex items-center gap-2 text-[10px] uppercase tracking-widest">
                ${blogUI.readMore[lang]}
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              </span>
            </div>
          </div>
        </a>
      `).join('');

    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const container = document.getElementById('pagination-container');
    if (!container || totalPages <= 1) {
        if (container) container.innerHTML = '';
        return;
    }

    const { currentPage } = window.blogState;
    let html = `<button class="p-3 text-[var(--subtext)] hover:text-white transition ${currentPage === 1 ? 'opacity-20 pointer-events-none' : ''}" onclick="window.setPage(${currentPage - 1})">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      </button>`;

    for (let i = 1; i <= totalPages; i++) {
        html += `<button class="w-12 h-12 rounded-2xl border transition-all duration-300 ${i === currentPage ? 'bg-[var(--accent)] text-[#1e1e2e] border-[var(--accent)] shadow-lg scale-110 font-black' : 'border-white/5 text-[var(--subtext)] hover:bg-white/5'}" onclick="window.setPage(${i})">${i}</button>`;
    }

    html += `<button class="p-3 text-[var(--subtext)] hover:text-white transition ${currentPage === totalPages ? 'opacity-20 pointer-events-none' : ''}" onclick="window.setPage(${currentPage + 1})">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </button>`;
    container.innerHTML = html;
}

// 全局分页跳转
window.setPage = (page) => {
    window.blogState.currentPage = page;
    renderPosts();
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

// 事件监听初始化
document.addEventListener('DOMContentLoaded', () => {
    // 搜索监听
    document.getElementById('search-input')?.addEventListener('input', (e) => {
        window.blogState.searchQuery = e.target.value;
        window.blogState.currentPage = 1;
        renderPosts();
    });

    // 分类按钮监听
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const cat = btn.dataset.category;
            window.blogState.currentCategory = window.blogState.currentCategory === cat ? null : cat;

            // 更新 UI 高亮
            document.querySelectorAll('.category-btn').forEach(b =>
                b.classList.toggle('bg-white/10', b.dataset.category === window.blogState.currentCategory)
            );

            const tagIndicator = document.getElementById('active-filter-tag');
            if (tagIndicator) {
                tagIndicator.innerText = window.blogState.currentCategory || '';
                tagIndicator.classList.toggle('hidden', !window.blogState.currentCategory);
            }

            window.blogState.currentPage = 1;
            renderPosts();
        });
    });

    // 执行初次渲染
    renderPosts();
});
</script>
</BaseLayout>