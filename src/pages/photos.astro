---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_CONFIG } from '../data/site-config';

/**
 * 摄影墙页面 - Astro 5.0 稳定版
 * 修复：
 * 1. 优化布局结构，防止不同比例图片导致的重叠变形。
 * 2. 限制最大列数为 3 列，提供更多呼吸感。
 * 3. 严格限制分页为每页 6 张，确保 UI 行为统一。
 * 注意：动态生成的图片必须存放在 public/ 目录下才能被客户端脚本正常访问。
 */

// 1. 获取语言和数据
const currentPath = Astro.url.pathname;
const isEnglish = currentPath.startsWith('/en');
const lang = isEnglish ? 'en' : 'ja';

const allPhotosRaw = await getCollection('photos') || [];
const sortedPhotos = (allPhotosRaw || [])
    .filter(p => p.data.lang === lang || !p.data.lang)
    .sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));

// 2. 提取过滤器选项
const getUniqueTags = (key: 'location_tag' | 'year_tag' | 'collection_tag') => {
    const tags = new Set(sortedPhotos.map(p => p.data[key]).filter(Boolean));
    return ['All', ...Array.from(tags)].sort();
};

const filterOptions = {
    locations: getUniqueTags('location_tag'),
    years: getUniqueTags('year_tag'),
    collections: getUniqueTags('collection_tag'),
};

// 3. UI 文本
const ui = {
    heading: { ja: "フォトギャラリー", en: "Photo Gallery" },
    subheading: { ja: "一瞬の光、永遠の記憶。", en: "Capturing moments, preserved forever." },
    labels: {
        location: { ja: "Location", en: "Location" },
        time: { ja: "Time", en: "Time" },
        collection: { ja: "Collection", en: "Collection" },
        exif: { ja: "EXIF", en: "EXIF" }
    },
    status: {
        empty: { ja: "写真が見つかりませんでした。", en: "No photos found." }
    }
};

// 4. 客户端数据序列化
const clientPhotos = sortedPhotos.map(p => {
    const { title, location, image, date, location_tag, year_tag, collection_tag, gear, exif, featured } = p.data;
    const getVal = (field: any, currentLang: string) => {
        if (!field) return "";
        if (typeof field === 'string') return field;
        return field[currentLang] || field['ja'] || field['en'] || "";
    };

    return {
        id: p.id,
        image, // 这里的路径必须指向 public 目录下的资源
        title: getVal(title, lang),
        location: getVal(location, lang),
        date,
        location_tag,
        year_tag,
        collection_tag,
        gear,
        exif,
        featured
    };
});
---

    <BaseLayout title={`${ui.heading[lang]} - ${SITE_CONFIG.brand.logo}`} lang={lang}>
<div class="max-w-6xl mx-auto px-6 sm:px-10 space-y-12 text-left">

<!-- 头部 -->
<header class="space-y-3 pt-8">
<h1 class="text-5xl font-black text-white tracking-tighter italic border-b-4 border-[var(--peach)]/10 inline-block pb-1">
    {ui.heading[lang]}
    </h1>
    <p class="text-[var(--subtext)] text-[10px] uppercase tracking-[0.4em] font-bold opacity-30 italic">
    {ui.subheading[lang]}
    </p>
    </header>

    <!-- 极简过滤器面板 -->
    <nav class="space-y-2 bg-white/[0.01] p-6 rounded-[2.5rem] border border-white/5 backdrop-blur-xl">
<div class="flex flex-col md:flex-row md:items-center gap-4">
<div class="flex items-center gap-2 w-24 shrink-0 text-[9px] font-black text-white/20 uppercase tracking-widest font-mono">
    <span>{ui.labels.collection[lang]}</span>
    </div>
    <div class="flex flex-wrap gap-1.5">
    {filterOptions.collections.map(val => (
            <button class="filter-btn px-3 py-1 rounded-lg border border-white/5 text-[10px] font-mono transition-all bg-white/5 text-[var(--subtext)] hover:text-white" data-type="collection" data-value={val}>{val}</button>
))}
</div>
</div>

<div class="flex flex-col md:flex-row md:items-center gap-4 pt-1 border-t border-white/5">
<div class="flex items-center gap-2 w-24 shrink-0 text-[9px] font-black text-white/20 uppercase tracking-widest font-mono">
    <span>{ui.labels.location[lang]}</span>
    </div>
    <div class="flex flex-wrap gap-1.5">
    {filterOptions.locations.map(val => (
            <button class="filter-btn px-3 py-1 rounded-lg border border-white/5 text-[10px] font-mono transition-all bg-white/5 text-[var(--subtext)] hover:text-white" data-type="location" data-value={val}>{val}</button>
))}
</div>
</div>

<div class="flex flex-col md:flex-row md:items-center gap-4 pt-1 border-t border-white/5">
<div class="flex items-center gap-2 w-24 shrink-0 text-[9px] font-black text-white/20 uppercase tracking-widest font-mono">
    <span>{ui.labels.time[lang]}</span>
    </div>
    <div class="flex flex-wrap gap-1.5">
    {filterOptions.years.map(val => (
            <button class="filter-btn px-3 py-1 rounded-lg border border-white/5 text-[10px] font-mono transition-all bg-white/5 text-[var(--subtext)] hover:text-white" data-type="year" data-value={val}>{val}</button>
))}
</div>
</div>
</nav>

<!-- 摄影网格 (固定 3 列布局) -->
<main class="w-full">
<div class="masonry-grid" id="photo-grid">
    <!-- JS 动态渲染 -->
</div>
</main>

<!-- 分页导航 -->
<nav id="pagination-container" class="flex justify-center items-center gap-3 pt-6 pb-20"></nav>
    </div>

    <!-- 灯箱组件 -->
    <div id="lightbox" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center bg-black/98 backdrop-blur-3xl p-4 transition-all duration-500" onclick="if(event.target===this)window.closeLightbox()">
<button id="close-lb" class="absolute top-8 right-8 p-3 bg-white/5 hover:bg-white/10 rounded-full text-white/50 hover:text-white transition border border-white/10" onclick="window.closeLightbox()">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>
    <div class="relative w-full max-w-5xl max-h-[75vh] flex items-center justify-center">
<img id="lb-img" src="" class="max-w-full max-h-[75vh] rounded-3xl object-contain shadow-2xl" />
<button id="prev-lb" class="absolute left-4 p-4 rounded-full text-white/10 hover:text-[var(--peach)] hover:bg-white/5 transition-all hidden md:flex" onclick="window.navigateLightbox(-1)">
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    </button>
    <button id="next-lb" class="absolute right-4 p-4 rounded-full text-white/10 hover:text-[var(--peach)] hover:bg-white/5 transition-all hidden md:flex" onclick="window.navigateLightbox(1)">
<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    </button>
    </div>
    <div class="mt-8 text-center space-y-1.5 max-w-2xl px-4 text-white">
<h3 id="lb-title" class="text-xl font-black italic tracking-tight"></h3>
    <p id="lb-meta" class="font-mono text-[9px] text-[var(--peach)] tracking-widest uppercase font-bold opacity-80"></p>
    <div id="lb-counter" class="text-[8px] font-mono text-white/20 uppercase tracking-[0.4em] mt-2"></div>
    </div>
    </div>

    <style>
/* 瀑布流布局核心修复：防止不同比例图片重叠 */
.masonry-grid {
    column-count: 1;
    column-gap: 2rem;
    width: 100%;
}
@media (min-width: 640px) { .masonry-grid { column-count: 2; } }
@media (min-width: 1024px) { .masonry-grid { column-count: 3; } }

.masonry-item {
    display: inline-block;
    width: 100%;
    break-inside: avoid;
    margin-bottom: 2rem;
}

.filter-btn.active {
    background-color: var(--peach);
    color: #1e1e2e;
    border-color: var(--peach);
    font-weight: 900;
}

.photo-card {
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
}
.photo-card:hover { transform: translateY(-8px); border-color: var(--peach)/40; }

@keyframes cardFadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-card { animation: cardFadeIn 0.7s ease-out forwards; }
</style>

<script is:inline define:vars={{ clientPhotos, lang, ui }}>
const state = {
    currentPage: 1,
    pageSize: 6,
    filters: { location: 'All', year: 'All', collection: 'All' },
    filteredAll: [...clientPhotos]
};

let lbIndex = 0;

function renderGrid() {
    const grid = document.getElementById('photo-grid');
    const pagination = document.getElementById('pagination-container');
    if (!grid) return;

    // 1. 执行全局过滤
    state.filteredAll = clientPhotos.filter(p => {
        const matchesLoc = state.filters.location === 'All' || p.location_tag === state.filters.location;
        const matchesYear = state.filters.year === 'All' || p.year_tag === state.filters.year;
        const matchesColl = state.filters.collection === 'All' || p.collection_tag === state.filters.collection;
        return matchesLoc && matchesYear && matchesColl;
    });

    const totalItems = state.filteredAll.length;
    const totalPages = Math.ceil(totalItems / state.pageSize);

    const start = (state.currentPage - 1) * state.pageSize;
    const paginated = state.filteredAll.slice(start, start + state.pageSize);

    if (totalItems === 0) {
        grid.innerHTML = `<div class="py-32 text-center opacity-20 font-mono w-full col-span-full border border-dashed border-white/5 rounded-[3rem] italic">${ui.status.empty[lang]}</div>`;
        pagination.innerHTML = '';
        return;
    }

    // 3. 渲染
    grid.innerHTML = paginated.map((p, idx) => `
        <div class="masonry-item animate-card" style="animation-delay: ${idx * 0.05}s">
          <article class="photo-card bento-card bg-[#313244]/20 rounded-[2.5rem] overflow-hidden flex flex-col group cursor-zoom-in border border-white/5 relative" onclick="window.openLightbox(${start + idx})">
            <div class="relative overflow-hidden bg-[#11111b] aspect-auto">
              <img 
                src="${p.image}" 
                class="w-full h-auto object-cover opacity-90 group-hover:opacity-100 group-hover:scale-105 transition-all duration-[1.2s] ease-out" 
                loading="lazy"
                decoding="async"
                onerror="this.style.opacity='0.2'; console.error('Image load failed:', this.src);"
              />
            </div>
            <div class="p-3 bg-gradient-to-b from-transparent to-black/20 text-left">
              <div class="flex items-center justify-between">
                <h4 class="text-xs font-bold text-white group-hover:text-[var(--peach)] transition-colors truncate tracking-tight leading-none">${p.title}</h4>
                <span class="text-[9px] font-mono text-white/20 font-black tracking-tighter">${p.year_tag || ''}</span>
              </div>
            </div>
          </article>
        </div>
      `).join('');

    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const container = document.getElementById('pagination-container');
    if (!container || totalPages <= 1) {
        if(container) container.innerHTML = '';
        return;
    }

    let html = `<button class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-[var(--subtext)] hover:text-white transition ${state.currentPage === 1 ? 'opacity-10 pointer-events-none' : ''}" onclick="window.setPage(${state.currentPage - 1})">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
      </button>`;

    for (let i = 1; i <= totalPages; i++) {
        const isActive = i === state.currentPage;
        html += `<button class="w-10 h-10 rounded-xl border transition-all duration-300 text-[10px] font-mono font-black ${isActive ? 'bg-[var(--peach)] text-[#1e1e2e] border-[var(--peach)] shadow-xl scale-110' : 'border-white/5 text-[var(--subtext)] hover:bg-white/10'}" onclick="window.setPage(${i})">${i}</button>`;
    }

    html += `<button class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 text-[var(--subtext)] hover:text-white transition ${state.currentPage === totalPages ? 'opacity-10 pointer-events-none' : ''}" onclick="window.setPage(${state.currentPage + 1})">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m9 18 6-6-6-6"/></svg>
      </button>`;

    container.innerHTML = html;
}

window.setPage = (page) => {
    state.currentPage = page;
    renderGrid();
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

window.openLightbox = (index) => {
    lbIndex = index;
    const lb = document.getElementById('lightbox');
    const photo = state.filteredAll[lbIndex];
    if (!photo) return;

    document.getElementById('lb-img').src = photo.image;
    document.getElementById('lb-title').innerText = photo.title;
    const ex = photo.exif;
    const metaStr = ex && ex.aperture ? `${ex.camera || photo.gear} // ${ex.aperture} ${ex.shutter} ISO${ex.iso}` : photo.gear;
    document.getElementById('lb-meta').innerText = `${photo.location} | ${metaStr}`;
    document.getElementById('lb-counter').innerText = `${lbIndex + 1} / ${state.filteredAll.length}`;

    lb.classList.remove('hidden');
    lb.classList.add('flex');
    document.body.style.overflow = 'hidden';
};

window.closeLightbox = () => {
    document.getElementById('lightbox').classList.add('hidden');
    document.body.style.overflow = '';
};

window.navigateLightbox = (dir) => {
    if (state.filteredAll.length <= 1) return;
    lbIndex = (lbIndex + dir + state.filteredAll.length) % state.filteredAll.length;
    window.openLightbox(lbIndex);
};

document.addEventListener('DOMContentLoaded', () => {
    renderGrid();
    document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.value === 'All') btn.classList.add('active');
        btn.onclick = () => {
            const { type, value } = btn.dataset;
            state.filters[type] = value;
            state.currentPage = 1;
            document.querySelectorAll(`.filter-btn[data-type="${type}"]`).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderGrid();
        };
    });
    window.onkeydown = (e) => {
        const lb = document.getElementById('lightbox');
        if (!lb.classList.contains('hidden')) {
            if (e.key === 'Escape') window.closeLightbox();
            if (e.key === 'ArrowLeft') window.navigateLightbox(-1);
            if (e.key === 'ArrowRight') window.navigateLightbox(1);
        }
    };
});
</script>
</BaseLayout>