---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_CONFIG } from '../data/site-config';

/**
 * 视频墙页面 - 完美适配版
 * 1. 自动识别本地 /assets/ 路径与远程 Unsplash ID。
 * 2. 包含 Hero 区、Latest 视频区和垂直短视频区。
 * 3. 集成 AI 助手交互。
 */

// 1. 获取语言环境
const currentPath = Astro.url.pathname;
const isEnglish = currentPath.startsWith('/en');
const lang = isEnglish ? 'en' : 'ja';

// 2. 获取视频数据
const allEntries = await getCollection('videos') || [];
const sortedVideos = allEntries
    .filter(v => v.data.lang === lang || !v.data.lang)
    .sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));

// 分类逻辑
const featuredVideo = sortedVideos.find(v => v.data.featured && v.data.type === 'long') || sortedVideos[0];
const longVideos = sortedVideos.filter(v => v.data.type === 'long');
const shortVideos = sortedVideos.filter(v => v.data.type === 'short');

/**
 * 图片路径处理辅助函数
 * 兼容：本地绝对路径 (/assets/...)、远程链接 (http...)、Unsplash ID
 */
const getImageUrl = (img: string) => {
    if (!img) return "";
    if (img.startsWith('http') || img.startsWith('/')) {
        return img;
    }
    return `https://images.unsplash.com/photo-${img}?q=80&w=1200&fit=crop`;
};

// 3. UI 文本字典
const ui = {
    heading: { ja: "動画ライブラリ", en: "Video Library" },
    latest: { ja: "最新の動画", en: "Latest Videos" },
    shorts: { ja: "ショート動画", en: "Shorts & Clips" },
    watch: { ja: "今すぐ視聴", en: "Watch Now" },
    ai: {
        title: { ja: "庭園の精霊", en: "Garden Spirit" },
        welcome: { ja: "どのような動画スタイルがお好きですか？", en: "What kind of video style do you prefer?" },
        placeholder: { ja: "質問を入力...", en: "Ask me anything..." }
    }
};
---

    <BaseLayout title={`Videos - ${SITE_CONFIG.brand.logo}`} lang={lang}>
<div class="max-w-6xl mx-auto space-y-16 text-left">

    <!-- 1. 精选视频 (Featured Hero Section) -->
{featuredVideo && (
    <section class="group relative rounded-[2.5rem] overflow-hidden aspect-video md:aspect-[21/9] border border-white/10 shadow-2xl bg-[#11111b]">
    <img
        src={getImageUrl(featuredVideo.data.image)}
class="absolute inset-0 w-full h-full object-cover transition duration-1000 group-hover:scale-105 opacity-60"
alt=""
/>
<div class="absolute inset-0 bg-gradient-to-t from-[#1e1e2e] via-transparent to-transparent"></div>

    <div class="absolute bottom-0 left-0 p-8 md:p-12 w-full md:w-2/3 space-y-4">
<div class="flex flex-wrap gap-2">
    {featuredVideo.data.tags?.map(tag => (
            <span class="px-2.5 py-1 bg-red/10 text-red text-[10px] font-mono font-bold uppercase rounded-md tracking-wider border border-red/20 backdrop-blur-md">
                {tag}
                </span>
        ))}
    </div>
    <h1 class="text-3xl md:text-5xl font-black text-white leading-tight tracking-tighter italic">
    {featuredVideo.data.title}
    </h1>
    <p class="text-[var(--subtext)] text-sm md:text-base line-clamp-2 max-w-xl font-medium">
    {featuredVideo.data.desc}
    </p>
    <div class="flex flex-wrap items-center gap-6 pt-4">
<a href={featuredVideo.data.url} class="bg-red text-[#1e1e2e] font-black px-8 py-3 rounded-full hover:scale-105 active:scale-95 transition shadow-[0_0_30px_rgba(243,139,168,0.4)] flex items-center gap-2">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
{ui.watch[lang]}
</a>
<span class="font-mono text-[10px] text-gray-500 uppercase tracking-widest font-bold">
    {featuredVideo.data.views || '0'} VIEWS • {featuredVideo.data.duration}
</span>
</div>
</div>
</section>
)}

<!-- 2. 最新视频网格 (Latest Videos) -->
<section>
    <div class="flex items-center gap-3 mb-8 px-2">
<div class="w-2 h-8 bg-red rounded-full shadow-[0_0_15px_rgba(243,139,168,0.5)]"></div>
    <h2 class="text-2xl font-black text-white tracking-tight uppercase italic">{ui.latest[lang]}</h2>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {longVideos.map(v => (
            <a href={v.data.url} class="video-card bento-card bg-[#313244]/30 rounded-[2.5rem] overflow-hidden group border border-white/5 transition-all duration-500 hover:-translate-y-2">
        <div class="aspect-video relative overflow-hidden bg-[#181825]">
        <img
            src={getImageUrl(v.data.image)}
class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-700"
loading="lazy"
/>
<div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
<div class="play-btn w-14 h-14 rounded-full border-2 border-white flex items-center justify-center text-white backdrop-blur-md scale-75 group-hover:scale-100 transition-transform duration-500">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="ml-1"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    </div>
    </div>
    <div class="absolute bottom-3 right-3 px-2 py-0.5 bg-black/80 text-white text-[10px] font-mono rounded-md font-bold backdrop-blur-md">
    {v.data.duration}
    </div>
    </div>
    <div class="p-6">
<div class="flex items-center gap-2 mb-3">
<span class="text-[9px] font-black font-mono uppercase tracking-widest text-red/80 bg-red/5 border border-red/10 px-2 py-0.5 rounded-md">
    {v.data.category || 'VLOG'}
    </span>
    </div>
    <h3 class="font-bold text-white text-lg leading-tight mb-3 group-hover:text-red transition line-clamp-2 tracking-tight">
    {v.data.title}
    </h3>
    <div class="text-[10px] font-mono text-gray-500 flex justify-between uppercase font-bold tracking-tighter opacity-60">
    <span>{v.data.views || '0'} VIEWS</span>
<span>{v.data.date}</span>
</div>
</div>
</a>
))}
</div>
</section>

<!-- 3. 短视频区 (Shorts) -->
<section>
<div class="flex items-center gap-3 mb-8 px-2">
<div class="w-2 h-8 bg-peach rounded-full shadow-[0_0_15px_rgba(250,179,135,0.5)]"></div>
    <h2 class="text-2xl font-black text-white tracking-tight uppercase italic">{ui.shorts[lang]}</h2>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
    {shortVideos.map(s => (
            <a href={s.data.url} class="bento-card bg-[#313244]/20 rounded-3xl overflow-hidden group relative aspect-[9/16] border border-white/5 transition-all duration-500 hover:scale-[1.02]">
        <img
            src={getImageUrl(s.data.image)}
class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition duration-1000 group-hover:scale-110"
loading="lazy"
/>
<div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-80"></div>
    <div class="absolute bottom-4 left-4 right-4 text-left">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-peach mb-2"><path d="m13 2-2 2.5h3L12 13h3l-4 9 2-2.5h-3L12 11h-3z"/></svg>
    <h4 class="text-xs font-bold text-white line-clamp-2 leading-snug tracking-tight">
    {s.data.title}
    </h4>
    </div>
    </a>
))}
</div>
</section>

</div>

<!-- 4. AI 助手 UI (悬浮窗) -->
<div id="ai-chat-window" class="fixed bottom-24 right-6 w-80 max-h-[450px] bg-[#313244]/95 border border-white/10 rounded-[2.5rem] shadow-2xl flex-col overflow-hidden text-left hidden backdrop-blur-2xl z-[120]">
<div class="p-5 border-b border-white/5 flex justify-between items-center bg-red/5">
<h4 class="text-xs font-black text-red flex items-center gap-2 uppercase tracking-widest">
<div class="w-1.5 h-1.5 rounded-full bg-red animate-pulse"></div>
{ui.ai.title[lang]}
</h4>
<button id="close-ai" class="p-1.5 hover:bg-white/10 rounded-full transition text-white/30 hover:text-white">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>
    </div>
    <div id="ai-messages" class="flex-1 p-5 overflow-y-auto scroller space-y-4 text-[11px] leading-relaxed">
<div class="ai-bubble p-3 text-[var(--subtext)] bg-white/5 rounded-2xl rounded-tl-none border border-white/5">
    {ui.ai.welcome[lang]}
    </div>
    </div>
    <div class="p-4 bg-white/[0.02] border-t border-white/5 flex gap-2">
<input type="text" id="ai-input" class="flex-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-2 text-xs text-white placeholder:text-gray-600 focus:outline-none focus:border-red/40 transition-all font-medium" placeholder={ui.ai.placeholder[lang]}>
<button id="send-ai" class="p-2.5 bg-red text-[#1e1e2e] rounded-2xl hover:opacity-90 transition shadow-lg active:scale-95">
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
    </button>
    </div>
    </div>

    <!-- AI 切换按钮 -->
    <button id="toggle-ai" class="fixed bottom-6 right-6 w-14 h-14 bg-red text-[#1e1e2e] rounded-2xl flex items-center justify-center shadow-[0_0_30px_rgba(243,139,168,0.3)] hover:scale-110 active:scale-95 transition-all z-[110]">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
    </button>

    <script is:inline define:vars={{ lang }}>
// AI 助手客户端逻辑
const toggleBtn = document.getElementById('toggle-ai');
const closeBtn = document.getElementById('close-ai');
const chatWin = document.getElementById('ai-chat-window');
const sendBtn = document.getElementById('send-ai');
const inputField = document.getElementById('ai-input');
const msgBox = document.getElementById('ai-messages');

function toggleChat() {
    const isHidden = chatWin.classList.contains('hidden');
    chatWin.classList.toggle('hidden', !isHidden);
    chatWin.style.display = isHidden ? 'flex' : 'none';
}

function appendMsg(role, text) {
    const div = document.createElement('div');
    div.className = role === 'ai'
        ? 'ai-bubble p-3 text-[var(--subtext)] bg-white/5 rounded-2xl rounded-tl-none border border-white/5 shadow-sm'
        : 'user-bubble p-3 text-white bg-red/10 rounded-2xl rounded-tr-none border border-red/10 ml-8 text-right font-bold shadow-sm';
    div.innerText = text;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
}

async function handleSend() {
    const val = inputField.value.trim();
    if (!val) return;
    appendMsg('user', val);
    inputField.value = '';

    // 模拟 AI 响应逻辑
    setTimeout(() => {
        const resp = lang === 'ja'
            ? "映像制作のご質問ですね！現在、新しい機材レビューを準備中です。"
            : "Great question about video making! I'm currently preparing some gear reviews.";
        appendMsg('ai', resp);
    }, 800);
}

toggleBtn?.addEventListener('click', toggleChat);
closeBtn?.addEventListener('click', toggleChat);
sendBtn?.addEventListener('click', handleSend);
inputField?.addEventListener('keypress', (e) => e.key === 'Enter' && handleSend());
</script>

<style>
.scroller::-webkit-scrollbar { width: 4px; }
.scroller::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
.video-card:hover { box-shadow: 0 20px 50px -15px rgba(243, 139, 168, 0.2); }
.play-btn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.video-card:hover .play-btn { transform: scale(1.15); background-color: white; color: #f38ba8; border-color: transparent; }
</style>
</BaseLayout>